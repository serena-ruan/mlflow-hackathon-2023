/** @jsxRuntime classic /
/** @jsx jsx */
import { Children, useEffect, useRef } from 'react';
import cx from 'classnames';
import { jsx } from '@emotion/react';
import { ErrorBoundary } from '../../index';
import styles from './SliderStories.css';
import * as breakpoints from '../../constants/breakpoints';
const BACKGROUND_COLORS = {
    'light-grey': 'uil-bgc-grey-100',
    transparent: 'uil-bgc-transparent',
    white: 'uil-bgc-white',
};
const StoryWrapper = ({ item, reverse }) => {
    if (!item)
        return null;
    const CustomTag = item.type;
    if (CustomTag.displayName && CustomTag.displayName === 'Story') {
        return (jsx(CustomTag, Object.assign({}, item.props, { reverse: reverse, className: cx('uil-slider-story-item uil-bdbw-0 uil-bdbs-solid uil-pv-48 md:uil-pv-120 md:uil-h-100vh', item.props.className), imageProps: {
                ...item.props.imageProps,
                className: cx('uil-d-block md:uil-d-none', item.props.imageProps.className),
            }, css: styles.opacityTransition })));
    }
    else {
        throw new Error("You can only use 'Story' components.");
    }
};
const ImageWrapper = ({ item, index, posterBackground, ...other }) => {
    if (!item)
        return null;
    const { alt: imageAlt, css: imageCss, tag: imageTag, className: imageClassName, ...otherImageProps } = item.props.imageProps;
    const CustomTag = imageTag || 'img';
    return (jsx(CustomTag, Object.assign({}, other, otherImageProps, { className: cx('uil-w-100p uil-h-100p uil-obf-contain uil-obp-center uil-pos-absolute uil-mh-auto md:uil-op-0', BACKGROUND_COLORS[posterBackground], imageClassName), css: [styles.opacityTransition, imageCss], src: item.props.image, alt: imageAlt, "data-uil-slider-stories": `image-index-${index}` })));
};
const SliderStories = ({ children, posterBackground = 'white', reverse = false, withLargerText = false, ...other }) => {
    const sliderContainerRef = useRef(null);
    const sliderRef = useRef(null);
    const sliderStoriesRef = useRef(null);
    const sliderPosterRef = useRef(null);
    const sliderPosterImagesContainerRef = useRef(null);
    const sliderTitleRef = useRef(null);
    const isInActionZone = (rect) => {
        return rect.top < 300 && rect.bottom > 200;
    };
    const watchChild = (child, index, sliderPoster) => {
        const childBoundingClientRect = child.getBoundingClientRect();
        const childPoster = sliderPoster.querySelector(`[data-uil-slider-stories="image-index-${index}"]`);
        if (isInActionZone(childBoundingClientRect)) {
            child.classList.add('md:uil-op-100p');
            child.classList.remove('md:uil-op-25p');
        }
        else {
            child.classList.remove('md:uil-op-100p');
            child.classList.add('md:uil-op-25p');
        }
        if (childPoster) {
            if (childBoundingClientRect.top < -300) {
                childPoster.classList.remove('md:uil-op-100p');
                childPoster.classList.add('md:uil-op-0');
            }
            else {
                childPoster.classList.remove('md:uil-op-0');
                childPoster.classList.add('md:uil-op-100p');
            }
        }
    };
    const resizePoster = (container) => {
        return `${container.width / 2}px`;
    };
    const placePoster = (sliderElements) => {
        const sliderContainerBoundingClientRect = sliderElements.sliderContainer.getBoundingClientRect();
        if (isInActionZone(sliderContainerBoundingClientRect)) {
            sliderElements.sliderPosterImagesContainer.classList.remove('uil-op-0');
            sliderElements.sliderPosterImagesContainer.classList.add('uil-op-100p');
        }
        else {
            sliderElements.sliderPosterImagesContainer.classList.add('uil-op-0');
            sliderElements.sliderPosterImagesContainer.classList.remove('uil-op-100p');
        }
        sliderElements.sliderPoster.style.width = resizePoster(sliderContainerBoundingClientRect);
        if (sliderElements.sliderTitle
            ? sliderElements.sliderPoster.getBoundingClientRect().top <= 0 &&
                sliderElements.sliderPoster.getBoundingClientRect().bottom <=
                    window.innerHeight
            : sliderContainerBoundingClientRect.top <= 0) {
            sliderElements.sliderPoster.classList.remove('uil-pos-absolute');
            sliderElements.sliderPoster.classList.add('uil-pos-fixed');
            if (reverse) {
                sliderElements.sliderPoster.style.left = `${sliderContainerBoundingClientRect.left +
                    sliderElements.sliderPoster.getBoundingClientRect().width}px`;
            }
            else {
                sliderElements.sliderPoster.style.left = `${sliderContainerBoundingClientRect.left}px`;
            }
        }
    };
    const onScroll = (reverse, sliderElements, sliderContainerBoundingClientRect) => {
        const currentSliderPoster = sliderElements.sliderPoster;
        sliderElements.sliderStoryItem.forEach((child, index) => {
            requestAnimationFrame(() => watchChild(child, index, sliderElements.sliderPoster));
        });
        placePoster(sliderElements);
        /** If the container reaches the top or the bottom of the page
         *  switch position from absolute/fixed.
         *
         *  Also fades the images in/out depending on the scroll position
         */
        if (sliderContainerBoundingClientRect.top >= 0) {
            if (currentSliderPoster.classList.contains('uil-pos-fixed') &&
                currentSliderPoster.classList.contains('uil-top-0')) {
                currentSliderPoster.classList.remove('uil-top-0');
                currentSliderPoster.classList.add('uil-bot-0');
            }
            if (currentSliderPoster.classList.contains('uil-pos-fixed') &&
                currentSliderPoster.classList.contains('uil-bot-0')) {
                currentSliderPoster.classList.remove('uil-bot-0');
                currentSliderPoster.classList.add('uil-top-0');
            }
            currentSliderPoster.classList.remove('uil-pos-fixed');
            currentSliderPoster.classList.add('uil-pos-absolute');
            // Fade out images if the container scrolled to the end
            if (reverse) {
                currentSliderPoster.style.left = `${sliderElements.sliderPoster.getBoundingClientRect().width}px`;
            }
            else {
                currentSliderPoster.style.left = 0;
            }
        }
        if (sliderContainerBoundingClientRect.bottom <= window.innerHeight) {
            currentSliderPoster.classList.remove('uil-pos-fixed');
            currentSliderPoster.classList.add('uil-pos-absolute');
            currentSliderPoster.classList.add('uil-bot-0');
            currentSliderPoster.classList.remove('uil-top-0');
            // Fade out images if the container scrolled to the end
            if (reverse) {
                currentSliderPoster.style.left = `${sliderElements.sliderPoster.getBoundingClientRect().width}px`;
            }
            else {
                currentSliderPoster.style.left = 0;
            }
        }
    };
    useEffect(() => {
        if (window.matchMedia &&
            window.matchMedia(`(min-width: ${breakpoints.MD})`).matches) {
            const sliderContainer = sliderContainerRef.current;
            const sliderPosterImagesContainer = sliderPosterImagesContainerRef.current;
            const sliderPoster = sliderPosterRef.current;
            const sliderTitle = sliderTitleRef.current;
            const sliderStories = sliderStoriesRef.current;
            const sliderStoryItem = sliderStories &&
                sliderStories.querySelectorAll('.uil-slider-story-item');
            const sliderElements = {
                sliderContainer,
                sliderPoster,
                sliderPosterImagesContainer,
                sliderStoryItem,
                sliderTitle,
            };
            const reqAnimOnEvent = () => {
                if (sliderContainer) {
                    requestAnimationFrame(() => onScroll(reverse, sliderElements, sliderContainer.getBoundingClientRect()));
                }
            };
            window.addEventListener('scroll', reqAnimOnEvent);
            window.addEventListener('resize', reqAnimOnEvent);
            if (sliderPoster && sliderContainer) {
                sliderPoster.style.width = resizePoster(sliderContainer.getBoundingClientRect());
            }
            return () => {
                window.removeEventListener('resize', reqAnimOnEvent);
                window.removeEventListener('scroll', reqAnimOnEvent);
            };
        }
        return () => { };
    }, []);
    return (jsx("div", Object.assign({}, other, { ref: sliderContainerRef }),
        jsx("div", { className: "uil-pos-relative", ref: sliderRef },
            jsx("div", { className: cx('uil-pos-absolute uil-top-0 uil-h-100vh uil-w-50p uil-pv-16 uil-d-none md:uil-d-block uil-z-5', reverse ? 'uil-right-0' : 'uil-left-0', BACKGROUND_COLORS[posterBackground]), ref: sliderPosterRef },
                jsx("div", { ref: sliderPosterImagesContainerRef, css: styles.opacityTransition, className: "uil-op-0 uil-pos-absolute uil-top-0 uil-bot-0 uil-right-0 uil-left-0 uil-w-100p uil-h-100p uil-m-auto" }, Children.map(children, (item, index) => (jsx(ImageWrapper, { item: item, index: index, posterBackground: posterBackground, style: {
                        zIndex: Children.count(children) - index,
                    } }))))),
            jsx("div", { ref: sliderStoriesRef }, Children.map(children, item => (jsx(ErrorBoundary, null,
                jsx(StoryWrapper, { item: item, reverse: reverse }))))))));
};
export default SliderStories;
